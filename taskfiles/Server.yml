version: '3'

vars:
  OUT_PATH: bin/gophkeeper-server

tasks:
  gen:sqlc:
    desc: Generate sqlc
    vars:
      SQLC_REPOSITORY: github.com/sqlc-dev/sqlc/cmd/sqlc@v1.30.0
      SQLC_CONFIG: internal/server/sqlite/sqlc/sqlc.yml
    cmds:
      - go run {{.SQLC_REPOSITORY}} generate -f {{.SQLC_CONFIG}}

  build:
    desc: Build server
    cmds:
      - go build -ldflags "-s -w" -o {{.OUT_PATH}} cmd/server/main.go

  run:
    desc: Run server
    env:
      SQLITE_DATA_FOLDER: data
    cmds:
      - task: build
      - ./{{.OUT_PATH}}

  watch:
    desc: Run server watching
    preconditions:
      - sh: test -n (which watchexec)
        msg: please install watchexec (https://github.com/watchexec/watchexec) to use this task
    env:
      SQLITE_DATA_FOLDER: data
    cmds:
      - watchexec -r -c -e go --poll 1000 -- go run cmd/server/main.go
